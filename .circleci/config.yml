version: 2.1

# Default configuration for persist_to_workspace and attach_workspace commands
persist_to_workspace: &persist_to_workspace
  persist_to_workspace:
    root: .
    paths:
      - .

attach_workspace: &attach_workspace
  attach_workspace:
    at: ~/project

executors:
  php-executor:
    resource_class: small
    shell: /bin/bash
    docker:
      - name: localhost
        image: cimg/php:8.2

  builder-executor:
    resource_class: small
    shell: /bin/bash
    docker:
      - image: cimg/php:8.2-node
        name: localhost

  simple-executor:
    resource_class: small
    shell: /bin/bash
    docker:
      - image: cimg/base:stable
        name: localhost

jobs:
  # ============================================
  # PARTIE 1 & 2 : JOBS EXISTANTS
  # ============================================

  debug-info:
    executor: php-executor
    steps:
      - checkout
      - run:
          name: Debug
          command: |
            echo "Current user: $USER"
            echo "Home directory: $HOME"
            echo "Current shell: $SHELL"
            echo "Operating system: $(uname -a)"
            echo "Current path: $PATH"
            echo "Current working directory: $(pwd)"
            echo "Current date: $(date)"
            echo "--------------------"
            env

  build-setup:
    executor: php-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "composer.json" }}
            - v1-dependencies-
      - run:
          name: Install dependencies
          command: composer install --no-interaction --no-ansi --prefer-dist
      - save_cache:
          paths:
            - ./vendor
          key: v1-dependencies-{{ checksum "composer.json" }}
      - *persist_to_workspace

  lint-phpcs:
    executor: php-executor
    steps:
      - *attach_workspace
      - run:
          name: Install PHP_CodeSniffer and PHPCompatibility
          command: composer require --dev "squizlabs/php_codesniffer=*" "phpcompatibility/php-compatibility=*"
      - run:
          name: Run PHP_CodeSniffer with Custom Ruleset in the project root
          command: |
            ./vendor/bin/phpcs --standard=phpcs.xml --report-file=phpcs-report.txt --report=checkstyle --extensions=php --ignore=vendor/ .
            result=$?
            if [ $result -eq 1 ] || [ $result -eq 2 ]; then
              exit 0
            else
              exit $result
            fi
      - store_artifacts:
          path: phpcs-report.txt
          destination: phpcs-report

  security-check-dependencies:
    executor: php-executor
    steps:
      - *attach_workspace
      - run:
          name: Install local-php-security-checker
          command: |
            curl -L -o local-php-security-checker https://github.com/fabpot/local-php-security-checker/releases/download/v2.0.6/local-php-security-checker_2.0.6_linux_amd64
            chmod +x local-php-security-checker
      - run:
          name: Run local-php-security-checker
          command: ./local-php-security-checker --format=json --no-dev > security-report.json
      - store_artifacts:
          path: security-report.json
          destination: security-report

  test-phpunit:
    executor: php-executor
    steps:
      - *attach_workspace
      - run:
          name: Check if PHPUnit tests are present, otherwise skip the job
          command: |
            if [ ! -f "phpunit.xml" ]; then
              echo "No PHPUnit tests found, skipping job."
              echo "export SKIP_PHPUNIT=true" >> $BASH_ENV
              circleci step halt
            fi
      - run:
          name: Install PHPUnit
          command: composer require --dev phpunit/phpunit
      - run:
          name: Run PHPUnit
          command: ./vendor/bin/phpunit --testsuite=Unit

  build-docker-image:
    executor: builder-executor
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build and Push Docker Image to GHCR
          command: |
            set -euo pipefail
            
            # ---- Infisical: load app secrets ----
            if [ -z "${INFISICAL_TOKEN:-}" ] || [ -z "${INFISICAL_ENV:-}" ]; then
              echo "INFISICAL_TOKEN or INFISICAL_ENV is missing in CircleCI env vars"
              exit 1
            fi

            # Install Infisical CLI
            curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash
            sudo apt-get update
            sudo apt-get install -y infisical

            # Export secrets and load into environment
            infisical export --projectId="$INFISICAL_PROJECT_ID" --env="$INFISICAL_ENV" --path="/" --format=dotenv > .env

            set -a
            source .env
            set +a

            # Proof in logs (no secret values)
            echo "Infisical loaded:"
            echo " - APP_ENV=${APP_ENV:-MISSING}"
            echo " - APP_SECRET=${APP_SECRET:+YES}"
            echo " - DATABASE_URL=${DATABASE_URL:+YES}"
            echo " - JWT_SECRET=${JWT_SECRET:+YES}"

            # Skip build check
            if [ "${SKIP_BUILD:-false}" = "true" ] || [ "${SKIP_BUILD:-0}" = "1" ] || [ "${SKIP_BUILD:-}" = "yes" ]; then
              echo "Skipping build"
              circleci step halt
            fi

            if [ -z "${GHCR_PAT:-}" ]; then
              echo "GHCR_PAT is not set in CircleCI env vars"
              exit 1
            fi

            GHCR_OWNER="$(echo "$CIRCLE_PROJECT_USERNAME" | tr '[:upper:]' '[:lower:]')"
            REPO_NAME="$(echo "$CIRCLE_PROJECT_REPONAME" | tr '[:upper:]' '[:lower:]')"
            REPOSITORY="ghcr.io/${GHCR_OWNER}/${REPO_NAME}"
            TAG="$(echo "$CIRCLE_BRANCH" | tr '[:upper:]' '[:lower:]' | tr '/' '-' | tr -cd '[:alnum:]._-' | cut -c 1-128)"

            echo "Logging in to GHCR as ${GHCR_OWNER}..."
            echo "$GHCR_PAT" | docker login ghcr.io -u "$GHCR_OWNER" --password-stdin

            echo "Building ${REPOSITORY}:${TAG}..."
            docker build \
              -f Docker/Dockerfile \
              -t "${REPOSITORY}:${TAG}" \
              --build-arg BUILD_DATE="$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
              --build-arg TAG="${TAG}" \
              --build-arg GIT_COMMIT="$(git rev-parse -q --verify HEAD)" \
              --build-arg GIT_URL="$(echo "${CIRCLE_REPOSITORY_URL}" | sed -e 's/^git@/https:\/\//g' -e 's/\.git$//g' -e 's/:/\//g')" \
              --build-arg SQLITE_VERSION=3430200 \
              --build-arg SQLITE_YEAR=2023 \
              --build-arg PROJECT_USERNAME="$CIRCLE_PROJECT_USERNAME" \
              .

            echo "Pushing ${REPOSITORY}:${TAG}..."
            docker push "${REPOSITORY}:${TAG}"

  deploy-ssh-staging:
    executor: simple-executor
    steps:
      - add_ssh_keys:
          fingerprints:
            - "${STAGING_SSH_FINGERPRINT}"
      - run:
          name: Deploy to AWS Staging
          command: |
            set -euo pipefail
            
            ssh -o StrictHostKeyChecking=no $STAGING_SSH_USER@$STAGING_SSH_HOST "
              PHP_FPM_VERSION=\$(php -v | head -n 1 | cut -d ' ' -f 2 | cut -d '.' -f 1-2) &&
              cd $STAGING_DEPLOY_DIRECTORY &&
              sudo chown -R ec2-user:ec2-user
              git pull origin $CIRCLE_BRANCH &&
              composer install --optimize-autoloader --no-interaction --prefer-dist &&
              (flock -w 10 9 || exit 1; sudo -S service php\${PHP_FPM_VERSION}-fpm restart) 9>/tmp/fpm.lock
            "

  deploy-ssh-production:
    executor: simple-executor
    steps:
      - add_ssh_keys:
          fingerprints:
            - "${PROD_SSH_FINGERPRINT}"
      - run:
          name: Deploy to AWS Production
          command: |
            set -euo pipefail
            
            echo "=========================================="
            echo " Deploying to Production"
            echo "=========================================="
            echo "Host: ${PROD_SSH_HOST}"
            echo "User: ${PROD_SSH_USER}"
            echo "Directory: ${PROD_DEPLOY_DIRECTORY}"
            echo ""
            
            # Deploy using inline SSH commands
            ssh -o StrictHostKeyChecking=no ${PROD_SSH_USER}@${PROD_SSH_HOST} "
              set -euo pipefail &&
              echo ' Navigating to deployment directory...' &&
              cd ${PROD_DEPLOY_DIRECTORY} &&
              echo 'üîß Restoring ownership to ec2-user for git operations...' &&
              sudo chown -R ec2-user:ec2-user ${PROD_DEPLOY_DIRECTORY} &&
              echo ' Pulling latest changes from main...' &&
              git fetch origin &&
              git reset --hard origin/main &&
              echo ' Installing dependencies...' &&
              composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader &&
              echo ' Setting permissions for nginx...' &&
              sudo chown -R nginx:nginx ${PROD_DEPLOY_DIRECTORY} &&
              sudo chmod -R 755 ${PROD_DEPLOY_DIRECTORY} &&
              echo ' Restarting PHP-FPM...' &&
              PHP_FPM_VERSION=\$(php -v | head -n 1 | cut -d ' ' -f 2 | cut -d '.' -f 1-2) &&
              sudo systemctl restart php-fpm &&
              echo ' Reloading Nginx...' &&
              sudo nginx -t && sudo systemctl reload nginx &&
              echo '' &&
              echo '==========================================' &&
              echo ' Deployment completed successfully!' &&
              echo '=========================================='
            "
      
      - run:
          name: Verify Deployment
          command: |
            echo " Verifying deployment..."
            sleep 5
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${PROD_SSH_HOST}/ || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo " Application is responding correctly (HTTP $HTTP_CODE)"
            else
              echo "  Application returned HTTP $HTTP_CODE"
              echo "Please check the deployment manually"
            fi
  # ============================================
  # PARTIE 3 : JOBS D'√âVALUATION DE CODE
  # ============================================

  metrics-phpmetrics:
    executor: php-executor
    steps:
      - *attach_workspace
      - run:
          name: Install PHPMetrics
          command: |
            curl -L https://github.com/phpmetrics/PhpMetrics/releases/latest/download/phpmetrics.phar -o phpmetrics.phar
            chmod +x phpmetrics.phar
      
      - run:
          name: Run PHPMetrics
          command: |
            mkdir -p reports/phpmetrics
            php phpmetrics.phar --report-html=reports/phpmetrics --exclude=vendor .
      
      - store_artifacts:
          path: reports/phpmetrics
          destination: phpmetrics-report
      
      - run:
          name: Display PHPMetrics Summary
          command: |
            echo "=========================================="
            echo " PHPMetrics - Code Analysis"
            echo "=========================================="
            echo "PHPMetrics report generated successfully!"
            echo "Analyzing code complexity and maintainability..."
            php phpmetrics.phar --report-json=reports/phpmetrics.json --exclude=vendor .
            
            if [ -f "reports/phpmetrics.json" ]; then
              echo " Analysis complete. Check artifacts for detailed report."
            fi

  metrics-phploc:
    executor: php-executor
    steps:
      - *attach_workspace
      - run:
          name: Install PHPLOC
          command: |
            curl -L https://phar.phpunit.de/phploc.phar -o phploc.phar
            chmod +x phploc.phar
      
      - run:
          name: Run PHPLOC
          command: |
            mkdir -p reports
            ./phploc.phar --exclude vendor --log-json reports/phploc.json . | tee reports/phploc.txt
      
      - store_artifacts:
          path: reports/phploc.txt
          destination: phploc-report
      
      - store_artifacts:
          path: reports/phploc.json
          destination: phploc-report-json
      
      - run:
          name: Display PHPLOC Summary
          command: |
            echo "=========================================="
            echo " PHPLOC - Lines of Code Statistics"
            echo "=========================================="
            cat reports/phploc.txt

  # ============================================
  # PARTIE 3 : JOBS DE QUALIT√â DU CODE
  # ============================================

  quality-phpmd:
    executor: php-executor
    steps:
      - *attach_workspace
      - run:
          name: Install PHPMD
          command: |
            curl -L https://github.com/phpmd/phpmd/releases/latest/download/phpmd.phar -o phpmd.phar
            chmod +x phpmd.phar
      
      - run:
          name: Run PHPMD
          command: |
            mkdir -p reports
            ./phpmd.phar . html cleancode,codesize,controversial,design,naming,unusedcode \
              --exclude vendor \
              --reportfile reports/phpmd.html || true
            
            ./phpmd.phar . text cleancode,codesize,controversial,design,naming,unusedcode \
              --exclude vendor | tee reports/phpmd.txt || true
      
      - store_artifacts:
          path: reports/phpmd.html
          destination: phpmd-report-html
      
      - store_artifacts:
          path: reports/phpmd.txt
          destination: phpmd-report-txt
      
      - run:
          name: Display PHPMD Summary
          command: |
            echo "=========================================="
            echo " PHPMD - Code Quality Analysis"
            echo "=========================================="
            if [ -f "reports/phpmd.txt" ]; then
              cat reports/phpmd.txt | head -n 50
            fi

  quality-php-doc-check:
    executor: php-executor
    steps:
      - *attach_workspace
      - run:
          name: Install PHP-Doc-Check
          command: |
            composer require --dev niels-de-blaauw/php-doc-check
      
      - run:
          name: Run PHP-Doc-Check
          command: |
            mkdir -p reports
            ./vendor/bin/php-doc-check \
              --directory src \
              --directory tests \
              --exclude vendor \
              --format json > reports/php-doc-check.json || true
            
            ./vendor/bin/php-doc-check \
              --directory src \
              --directory tests \
              --exclude vendor | tee reports/php-doc-check.txt || true
      
      - store_artifacts:
          path: reports/php-doc-check.json
          destination: php-doc-check-json
      
      - store_artifacts:
          path: reports/php-doc-check.txt
          destination: php-doc-check-txt
      
      - run:
          name: Display Documentation Coverage
          command: |
            echo "=========================================="
            echo " PHP Documentation Check"
            echo "=========================================="
            if [ -f "reports/php-doc-check.txt" ]; then
              cat reports/php-doc-check.txt
            fi

# ============================================
# WORKFLOWS
# ============================================

workflows:
  main_workflow:
    jobs:
      # Debug et setup
      - debug-info
      - build-setup
      
      # Jobs de validation (parall√®le)
      - lint-phpcs:
          requires:
            - build-setup
      - security-check-dependencies:
          requires:
            - build-setup
      - test-phpunit:
          requires:
            - build-setup
      
      # Jobs de m√©triques (parall√®le) - PARTIE 3
      - metrics-phpmetrics:
          requires:
            - build-setup
      - metrics-phploc:
          requires:
            - build-setup
      
      # Jobs de qualit√© (parall√®le) - PARTIE 3
      - quality-phpmd:
          requires:
            - build-setup
      - quality-php-doc-check:
          requires:
            - build-setup
      
      # Approbation manuelle pour production
      - hold-production:
          type: approval
          requires:
            - lint-phpcs
            - security-check-dependencies
            - test-phpunit
            - metrics-phpmetrics
            - metrics-phploc
            - quality-phpmd
            - quality-php-doc-check
          filters:
            branches:
              only:
                - main
      
      # D√©ploiement en production
      - deploy-ssh-production:
          requires:
            - hold-production
          filters:
            branches:
              only:
                - main

  container_workflow:
    jobs:
      - build-docker-image:
          filters:
            branches:
              only:
                - master
                - main
                - develop
                - /^feature\/.*/
                - /^release\/.*/
                - /^hotfix\/.*/
                - /^bugfix\/.*/

